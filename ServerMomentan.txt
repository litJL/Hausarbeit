#include <iostream>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <unistd.h>
#include <string>
#include <string.h>

#define BUFLEN 512
#define PORT 9930

using namespace std;

int main(void)
{
  struct sockaddr_in si_me={0};
  struct sockaddr_in si_other={0};
  int s, slen=sizeof(si_other);
  char buf[BUFLEN],bufCom[3];
  string buffer, bufferCode, bufferCommand;
  string CURRENT_PATH = "repo/";

  s=socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);

  si_me.sin_family = AF_INET;
  si_me.sin_port = htons(PORT);
  si_me.sin_addr.s_addr = htonl(INADDR_ANY);

  bind(s, (sockaddr*)&si_me, sizeof(si_me));
  system("clear");
  while (true)
  {
    recvfrom(s, bufCom, 3, 0, (sockaddr *)&si_other, (socklen_t*)&slen);
    bufferCommand = bufCom;
    bufferCommand.resize(3); //Benötigt weil buffer am ende immer ein 'v' setzt, keine Ahnung warum
    cout << bufferCommand << endl;
    if(bufferCommand == "mdr"){
        bufferCode="200";
        sendto(s, bufferCode.c_str(), bufferCode.length(), 0, (sockaddr *)&si_other, slen);
        memset(buf, 0, sizeof(buf));
        recvfrom(s, buf, BUFLEN, 0, (sockaddr *)&si_other, (socklen_t*)&slen);
        buffer = buf;
        buffer = "mkdir " + CURRENT_PATH + buffer;
        if(system(buffer.c_str()) == 0)bufferCode = "200";
        else bufferCode = "400";
        sendto(s, bufferCode.c_str(), buffer.length(), 0, (sockaddr *)&si_other, slen);
    }else if(bufferCommand == "cdr"){ //Funktioniert noch nicht so ganz
        bufferCode="200";
        sendto(s, bufferCode.c_str(), bufferCode.length(), 0, (sockaddr *)&si_other, slen);
        memset(buf, 0, sizeof(buf));
        recvfrom(s, buf, BUFLEN, 0, (sockaddr *)&si_other, (socklen_t*)&slen);
        buffer = buf;
        buffer = "cd " + CURRENT_PATH + buffer;
        if(system(buffer.c_str()) == 0)bufferCode = "200";
        else bufferCode = "400";
        sendto(s, bufferCode.c_str(), bufferCode.length(), 0, (sockaddr *)&si_other, slen);
        //CURRENT_PATH = CURRENT_PATH + buffer + "/";
    }else if(bufferCommand == "del"){
        bufferCode="200";
        sendto(s, bufferCode.c_str(), bufferCode.length(), 0, (sockaddr *)&si_other, slen);
        memset(buf, 0, sizeof(buf));
        recvfrom(s, buf, BUFLEN, 0, (sockaddr *)&si_other, (socklen_t*)&slen);
        buffer = buf;
        buffer = "rm " + CURRENT_PATH + buffer;
        if(system(buffer.c_str()) == 0)bufferCode = "200";
        else bufferCode = "400";
        sendto(s, bufferCode.c_str(), bufferCode.length(), 0, (sockaddr *)&si_other, slen);
    }else{
        bufferCode="400";
        sendto(s, bufferCode.c_str(), bufferCode.length(), 0, (sockaddr *)&si_other, slen);
    }
  }
  close(s);
  return 0;
}
